#!/bin/sh

#
# t - tmux session manager with zoxide integration
#
# Description:
#   Interactive tmux session switcher that uses zoxide for directory navigation
#   and fzf for fuzzy finding. Creates new sessions or switches to existing ones
#   based on directory selection.
#
# Usage:
#   t [directory]
#
# Dependencies:
#   - tmux: Terminal multiplexer
#   - zoxide: Smarter cd command with frecency-based directory tracking
#   - fzf: Fuzzy finder for directory selection
#
# Behavior:
#   - When not in tmux: Creates new session and attaches to it
#   - When in tmux: Creates session in detached mode and switches to it
#   - Session names are based on the directory basename
#   - Automatically changes to selected directory before creating session
#

# Check if not currently in tmux
if [ -z "$TMUX" ]; then
  # Not in tmux - will create and attach to new session

  # Use zoxide and fzf to select directory
  ZOXIDE_RESULT=$(zoxide query -l | fzf --reverse --height 40% --border)

  # Exit if user cancelled selection
  if [ -z "$ZOXIDE_RESULT" ]; then
    exit 0
  fi

  # Extract folder name for session naming
  FOLDER=$(basename "$ZOXIDE_RESULT")

  # Sanitize session name (tmux doesn't allow certain characters)
  FOLDER=$(echo "$FOLDER" | tr '.' '_')

  # Check if session already exists
  SESSION=$(tmux list-sessions 2>/dev/null | grep "^$FOLDER:" | awk '{print $1}')
  SESSION=${SESSION//:/}

  if [ -z "$SESSION" ]; then
    # Session does not exist - create new one
    cd "$ZOXIDE_RESULT" || exit 1
    tmux new-session -s "$FOLDER"
  else
    # Session exists - attach to it
    tmux attach -t "$SESSION"
  fi
else
  # Already in tmux - will create detached session and switch to it

  # Use zoxide and fzf to select directory
  ZOXIDE_RESULT=$(zoxide query -l | fzf --reverse --height 40% --border)

  # Exit if user cancelled selection
  if [ -z "$ZOXIDE_RESULT" ]; then
    exit 0
  fi

  # Extract folder name for session naming
  FOLDER=$(basename "$ZOXIDE_RESULT")

  # Sanitize session name (tmux doesn't allow certain characters)
  FOLDER=$(echo "$FOLDER" | tr '.' '_')

  # Check if session already exists
  SESSION=$(tmux list-sessions 2>/dev/null | grep "^$FOLDER:" | awk '{print $1}')
  SESSION=${SESSION//:/}

  if [ -z "$SESSION" ]; then
    # Session does not exist - create detached and switch to it
    cd "$ZOXIDE_RESULT" || exit 1
    tmux new-session -d -s "$FOLDER" -c "$ZOXIDE_RESULT"
    tmux switch-client -t "$FOLDER"
  else
    # Session exists - switch to it
    tmux switch-client -t "$SESSION"
  fi
fi
